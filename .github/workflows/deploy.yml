name: Deploy - Production

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: [self-hosted]

    env:
      DATA_FOLDER: ${{ vars.DATA_FOLDER }}
      DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
      SUBDOMAIN: ${{ vars.SUBDOMAIN }}
      GENERIC_TIMEZONE: ${{ vars.GENERIC_TIMEZONE }}
      SSL_EMAIL: ${{ vars.SSL_EMAIL }}
      REMOTE_PROJECT_PATH: ${{ vars.REMOTE_PROJECT_PATH }}
      POSTGRES_USER: ${{ vars.POSTGRES_USER }}
      POSTGRES_DB: ${{ vars.POSTGRES_DB }}
      POSTGRES_N8N_DB: ${{ vars.POSTGRES_N8N_DB }}
      POSTGRES_N8N_USER: ${{ vars.POSTGRES_N8N_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_N8N_PASSWORD: ${{ secrets.POSTGRES_N8N_PASSWORD }}
      N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Prepare deployment bundle
      # ------------------------------------------------------------
      - name: Prepare deployment bundle
        run: |
          set -euo pipefail

          mkdir -p deploy_bundle

          # docker-compose.yml
          cp docker/docker-compose.yml deploy_bundle/

          # Caddy config
          mkdir -p deploy_bundle/caddy_config
          sed "s/n8n\.<domain>\.<suffix>/${SUBDOMAIN}.${DOMAIN_NAME}/g" \
            docker/caddy_config/Caddyfile \
            > deploy_bundle/caddy_config/Caddyfile

          # PostgreSQL init scripts
          mkdir -p deploy_bundle/postgres-init
          cp docker/postgres-init/* deploy_bundle/postgres-init/

          # .env file for docker compose
          cat > deploy_bundle/.env <<EOF
          DATA_FOLDER=${DATA_FOLDER}
          DOMAIN_NAME=${DOMAIN_NAME}
          SUBDOMAIN=${SUBDOMAIN}
          GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
          SSL_EMAIL=${SSL_EMAIL}
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB}
          POSTGRES_N8N_DB=${POSTGRES_N8N_DB}
          POSTGRES_N8N_USER=${POSTGRES_N8N_USER}
          POSTGRES_N8N_PASSWORD=${POSTGRES_N8N_PASSWORD}
          N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
          EOF

          echo "üì¶ Deployment bundle prepared:"
          ls -la deploy_bundle
          echo "Caddyfile:"
          cat deploy_bundle/caddy_config/Caddyfile

      # ------------------------------------------------------------
      # Copy files to server filesystem
      # ------------------------------------------------------------
      - name: Copy deployment files
        run: |
          set -euo pipefail

          # Project path
          mkdir -p "${REMOTE_PROJECT_PATH}"
          cp -r deploy_bundle/. "${REMOTE_PROJECT_PATH}/"

          # Runtime data paths (mounted into containers)
          mkdir -p "${DATA_FOLDER}/caddy_config"
          mkdir -p "${DATA_FOLDER}/local_files"
          mkdir -p "${DATA_FOLDER}/postgres-init"

          # Copy Caddyfile to DATA_FOLDER (directory mount)
          cp deploy_bundle/caddy_config/Caddyfile \
             "${DATA_FOLDER}/caddy_config/Caddyfile"
          chmod 644 "${DATA_FOLDER}/caddy_config/Caddyfile"

          # Copy PostgreSQL init scripts
          cp -r deploy_bundle/postgres-init/* "${DATA_FOLDER}/postgres-init/"
          chmod +x "${DATA_FOLDER}/postgres-init/"*.sh 2>/dev/null || true

          echo "üìÅ Runtime paths:"
          ls -la "${DATA_FOLDER}/caddy_config"
          echo "Caddyfile:"
          cat "${DATA_FOLDER}/caddy_config/Caddyfile"

      # ------------------------------------------------------------
      # Deploy with Docker Compose
      # ------------------------------------------------------------
      - name: Deploy application
        run: |
          set -euo pipefail
          cd "${REMOTE_PROJECT_PATH}"

          # Verify docker-compose.yml exists
          if [ ! -f "docker-compose.yml" ]; then
            echo "‚ùå ERROR: docker-compose.yml not found in ${REMOTE_PROJECT_PATH}"
            echo "Current directory: $(pwd)"
            echo "Contents:"
            ls -la
            exit 1
          fi

          echo "üîÑ Pulling images..."
          docker compose pull

          echo "üßπ Stopping old containers..."
          docker compose down --remove-orphans

          echo "üöÄ Starting containers..."
          docker compose up -d

          echo "‚úÖ Deployment successful"
          docker ps --format "table {{.Names}}\t{{.Status}}"
