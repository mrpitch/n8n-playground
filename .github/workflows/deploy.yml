name: Deploy - Production

on:
  workflow_dispatch:
    inputs:
      deploy_only:
        description: "Deploy without building (use latest images)"
        required: false
        default: "false"

permissions:
  contents: read
  packages: read

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: [self-hosted]
    env:
      DATA_FOLDER: ${{ vars.DATA_FOLDER }}
      DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
      SUBDOMAIN: ${{ vars.SUBDOMAIN }}
      GENERIC_TIMEZONE: ${{ vars.GENERIC_TIMEZONE }}
      SSL_EMAIL: ${{ vars.SSL_EMAIL }}
      REMOTE_PROJECT_PATH: ${{ vars.REMOTE_PROJECT_PATH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine image tags
        id: images
        run: |
          set -euo pipefail
          REPO=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          echo "next_image=${REGISTRY}/${REPO}-next:latest" >> "$GITHUB_OUTPUT"
          echo "nginx_image=${REGISTRY}/${REPO}-nginx:latest" >> "$GITHUB_OUTPUT"

      - name: Prepare deployment bundle
        run: |
          set -euo pipefail
          
          echo "Current directory: $(pwd)"
          echo "Checking docker directory:"
          ls -la docker/ || echo "docker/ directory not found!"
          
          mkdir -p deploy_bundle
          
          # Verify files exist before copying
          if [ ! -f "docker/docker-compose.yml" ]; then
            echo "ERROR: docker/docker-compose.yml not found!"
            exit 1
          fi
          
          cp docker/docker-compose.yml deploy_bundle/
          
          # Copy caddy_config directory and process Caddyfile
          if [ -d "docker/caddy_config" ]; then
            mkdir -p deploy_bundle/caddy_config
            if [ -f "docker/caddy_config/Caddyfile" ]; then
              # Process Caddyfile: replace placeholder with actual domain
              sed "s/n8n\.<domain>\.<suffix>/${SUBDOMAIN}.${DOMAIN_NAME}/g" \
                docker/caddy_config/Caddyfile > deploy_bundle/caddy_config/Caddyfile
              echo "âœ… Processed Caddyfile with domain: ${SUBDOMAIN}.${DOMAIN_NAME}"
            else
              echo "âš ï¸  WARNING: docker/caddy_config/Caddyfile not found!"
            fi
          else
            echo "âš ï¸  WARNING: docker/caddy_config directory not found!"
          fi
          
          # Generate .env from secrets
          cat > deploy_bundle/.env << EOF
          
          DATA_FOLDER=${DATA_FOLDER}
          DOMAIN_NAME=${DOMAIN_NAME}
          SUBDOMAIN=${SUBDOMAIN}
          GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
          SSL_EMAIL=${SSL_EMAIL}
          EOF
          
          # Verify bundle was created
          echo "Deploy bundle contents:"
          ls -la deploy_bundle/
          if [ -d "deploy_bundle/caddy_config" ]; then
            echo "Caddyfile contents:"
            cat deploy_bundle/caddy_config/Caddyfile
          fi
          echo "Deploy bundle size:"
          du -sh deploy_bundle/

      - name: Copy deployment files to server
        run: |
          set -euo pipefail
          # Create directory structure
          mkdir -p "${REMOTE_PROJECT_PATH}"
          mkdir -p "${DATA_FOLDER}/caddy_config"
          mkdir -p "${DATA_FOLDER}/local_files"
          
          # CRITICAL: Remove any existing Caddyfile (file or directory) at the exact path Docker expects
          CADDYFILE_PATH="${DATA_FOLDER}/caddy_config/Caddyfile"
          if [ -e "${CADDYFILE_PATH}" ]; then
            echo "âš ï¸  Removing existing Caddyfile (file or directory) at ${CADDYFILE_PATH}"
            rm -rf "${CADDYFILE_PATH}"
          fi
          
          # Copy all files including hidden ones (like .env) to REMOTE_PROJECT_PATH
          cp -r deploy_bundle/. "${REMOTE_PROJECT_PATH}/"
          
          # CRITICAL: Explicitly copy Caddyfile to the exact path Docker Compose expects
          # Docker Compose mounts from ${DATA_FOLDER}/caddy_config/Caddyfile
          if [ -f "deploy_bundle/caddy_config/Caddyfile" ]; then
            cp deploy_bundle/caddy_config/Caddyfile "${CADDYFILE_PATH}"
            chmod 644 "${CADDYFILE_PATH}"
            echo "âœ… Caddyfile copied to exact Docker mount path: ${CADDYFILE_PATH}"
          else
            echo "âŒ ERROR: Caddyfile not found in deploy_bundle!"
            exit 1
          fi
          
          echo "Files copied to ${REMOTE_PROJECT_PATH}"
          ls -la "${REMOTE_PROJECT_PATH}"
          echo ""
          echo "Verifying Caddyfile at Docker mount path:"
          ls -la "${CADDYFILE_PATH}" || echo "ERROR: Caddyfile not at expected path!"
          echo ""
          echo "Caddyfile contents:"
          cat "${CADDYFILE_PATH}"

      - name: Deploy application
        run: |
          set -euo pipefail
          cd "${REMOTE_PROJECT_PATH}"
          
          # Fix docker-compose.yml to use .env instead of ../.env
          # (since docker-compose.yml and .env are now in the same directory)
          sed -i 's|\.\./\.env|.env|g' docker-compose.yml
          
          # Verify .env file exists
          if [ ! -f ".env" ]; then
            echo "ERROR: .env file not found in ${REMOTE_PROJECT_PATH}"
            ls -la
            exit 1
          fi
          
          # CRITICAL: Final verification of Caddyfile before Docker mount
          CADDYFILE_PATH="${DATA_FOLDER}/caddy_config/Caddyfile"
          echo "ðŸ” Final verification before Docker mount..."
          echo "Checking: ${CADDYFILE_PATH}"
          
          # Check if it exists
          if [ ! -e "${CADDYFILE_PATH}" ]; then
            echo "âŒ ERROR: Caddyfile does not exist at ${CADDYFILE_PATH}"
            echo "Directory structure:"
            ls -la "${DATA_FOLDER}/" || echo "DATA_FOLDER does not exist"
            ls -la "${DATA_FOLDER}/caddy_config/" || echo "caddy_config directory does not exist"
            exit 1
          fi
          
          # Check if it's a directory (this would cause the mount error)
          if [ -d "${CADDYFILE_PATH}" ]; then
            echo "âŒ ERROR: ${CADDYFILE_PATH} is a directory, not a file!"
            echo "Removing directory and recreating as file..."
            rm -rf "${CADDYFILE_PATH}"
            # Try to copy from REMOTE_PROJECT_PATH if it exists there
            if [ -f "${REMOTE_PROJECT_PATH}/caddy_config/Caddyfile" ]; then
              cp "${REMOTE_PROJECT_PATH}/caddy_config/Caddyfile" "${CADDYFILE_PATH}"
              chmod 644 "${CADDYFILE_PATH}"
              echo "âœ… Recreated Caddyfile from backup location"
            else
              echo "âŒ ERROR: Cannot recreate Caddyfile - source not found!"
              exit 1
            fi
          fi
          
          # Verify it's a regular file
          if [ ! -f "${CADDYFILE_PATH}" ]; then
            echo "âŒ ERROR: ${CADDYFILE_PATH} exists but is not a regular file!"
            ls -la "${CADDYFILE_PATH}"
            exit 1
          fi
          
          echo "âœ… Caddyfile verified: regular file at ${CADDYFILE_PATH}"
          echo "File details:"
          ls -la "${CADDYFILE_PATH}"
          echo ""
          echo "Caddyfile contents:"
          cat "${CADDYFILE_PATH}"
          
          export DOMAIN="${DOMAIN:-}"
          export SSL_EMAIL="${SSL_EMAIL:-}"
          export DOMAINS="${DOMAINS:-}"
          
          echo "ðŸ”„ Pulling latest images..."
          docker compose pull
          
          echo "ðŸ§¹ Removing old containers..."
          docker compose down --remove-orphans
          
          echo "ðŸš€ Starting updated containers..."
          docker compose up -d
          
          echo "âœ… Deployment completed successfully"
          docker ps --format "table {{.Names}}\t{{.Status}}"
