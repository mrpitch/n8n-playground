name: Deploy - Production

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: [self-hosted]

    env:
      DATA_FOLDER: ${{ vars.DATA_FOLDER }}
      DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
      SUBDOMAIN: ${{ vars.SUBDOMAIN }}
      GENERIC_TIMEZONE: ${{ vars.GENERIC_TIMEZONE }}
      SSL_EMAIL: ${{ vars.SSL_EMAIL }}
      REMOTE_PROJECT_PATH: ${{ vars.REMOTE_PROJECT_PATH }}

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Prepare deployment bundle
      # ------------------------------------------------------------
      - name: Prepare deployment bundle
        run: |
          set -euo pipefail

          mkdir -p deploy_bundle

          # docker-compose.yml
          cp docker/docker-compose.yml deploy_bundle/

          # Caddy config
          mkdir -p deploy_bundle/caddy_config
          sed "s/n8n\.<domain>\.<suffix>/${SUBDOMAIN}.${DOMAIN_NAME}/g" \
            docker/caddy_config/Caddyfile \
            > deploy_bundle/caddy_config/Caddyfile

          # .env file for docker compose
          cat > deploy_bundle/.env <<EOF
          DATA_FOLDER=${DATA_FOLDER}
          DOMAIN_NAME=${DOMAIN_NAME}
          SUBDOMAIN=${SUBDOMAIN}
          GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
          SSL_EMAIL=${SSL_EMAIL}
          EOF

          echo "ðŸ“¦ Deployment bundle prepared:"
          ls -la deploy_bundle
          echo "Caddyfile:"
          cat deploy_bundle/caddy_config/Caddyfile

      # ------------------------------------------------------------
      # Copy files to server filesystem
      # ------------------------------------------------------------
      - name: Copy deployment files
        run: |
          set -euo pipefail

          # Project path
          mkdir -p "${REMOTE_PROJECT_PATH}"
          cp -r deploy_bundle/. "${REMOTE_PROJECT_PATH}/"

          # Runtime data paths (mounted into containers)
          mkdir -p "${DATA_FOLDER}/caddy_config"
          mkdir -p "${DATA_FOLDER}/local_files"

          # Copy Caddyfile to DATA_FOLDER (directory mount)
          cp deploy_bundle/caddy_config/Caddyfile \
             "${DATA_FOLDER}/caddy_config/Caddyfile"
          chmod 644 "${DATA_FOLDER}/caddy_config/Caddyfile"

          echo "ðŸ“ Runtime paths:"
          ls -la "${DATA_FOLDER}/caddy_config"
          echo "Caddyfile:"
          cat "${DATA_FOLDER}/caddy_config/Caddyfile"

      # ------------------------------------------------------------
      # Deploy with Docker Compose
      # ------------------------------------------------------------
      - name: Deploy application
        run: |
          set -euo pipefail
          cd "${REMOTE_PROJECT_PATH}"

          echo "ðŸ”„ Pulling images..."
          docker compose pull

          echo "ðŸ§¹ Stopping old containers..."
          docker compose down --remove-orphans

          echo "ðŸš€ Starting containers..."
          docker compose up -d

          echo "âœ… Deployment successful"
          docker ps --format "table {{.Names}}\t{{.Status}}"
